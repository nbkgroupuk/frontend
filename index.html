<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Black Rock Terminal - Real-Time Card Payment Terminal</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&amp;display=swap" rel="stylesheet"/>
<style>
    body { font-family: 'Roboto Mono', monospace; background:#000; color:#e2e8f0; }
    input::-webkit-inner-spin-button, input::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
    @media print { body *{visibility:hidden;} #printableArea,#printableArea *{visibility:visible;} #printableArea{position:absolute;left:0;top:0;width:100%;} }
    .modal-backdrop{ background-color:rgba(0,0,0,0.75); }
  </style>
</head>
<body class="min-h-screen flex flex-col justify-center items-center p-6 bg-black">
<div class="w-full max-w-5xl bg-gray-900 rounded-2xl shadow-xl p-8 space-y-8 border border-gray-700">
<h1 class="text-4xl font-extrabold text-center mb-6 tracking-widest text-white select-none">Black Rock Terminal</h1>
<!-- LOGIN INTERFACE -->
<section aria-label="Merchant Login" class="max-w-md mx-auto bg-gray-900 rounded-lg p-6 shadow-lg border border-gray-700" id="loginSection" role="region">
<h2 class="text-2xl font-semibold mb-4 text-center text-white">Merchant Login</h2>
<form autocomplete="off" class="space-y-5" id="loginForm" novalidate="">
<div>
<label class="block mb-1 font-semibold text-gray-300" for="merchantEmail">Username</label>
<input aria-describedby="usernameHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" id="merchantEmail" name="merchantEmail" placeholder="admin" required="" type="text"/>
<p class="text-xs text-gray-500 mt-1 select-text" id="usernameHelp">Use username: <code>admin</code></p>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-300" for="merchantPassword">Password</label>
<input aria-describedby="passwordHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" id="merchantPassword" name="merchantPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required="" type="password"/>
<p class="text-xs text-gray-500 mt-1 select-text" id="passwordHelp">Use password: <code>Br_3339</code></p>
</div>
<div class="flex justify-between items-center">
<button aria-label="Login to payment terminal" class="bg-blue-600 hover:bg-blue-700 transition-colors duration-300 rounded-md py-3 font-semibold flex justify-center items-center space-x-2 px-6 text-white" type="submit">
<i class="fas fa-sign-in-alt"></i>
<span>Login</span>
</button>
<button aria-label="Forgot password" class="text-blue-400 hover:text-blue-600 underline text-sm focus:outline-none" id="forgotPasswordBtn" type="button">Forgot Password?</button>
</div>
</form>
<p aria-live="assertive" class="mt-3 text-red-500 text-center hidden" id="loginError" role="alert"></p>
</section>
<!-- TERMINAL ONLINE/OFFLINE STATUS -->
<div aria-atomic="true" aria-live="polite" class="max-w-md mx-auto flex justify-center items-center space-x-3 text-gray-400 select-none" id="terminalStatus" role="status">
<span class="w-4 h-4 rounded-full bg-red-600 animate-pulse" id="statusIndicator"></span>
<span class="text-sm font-semibold" id="statusText">Offline</span>
</div>
<!-- PAYMENT TERMINAL -->
<section aria-atomic="true" aria-label="Payment Terminal" aria-live="polite" class="hidden max-w-5xl mx-auto bg-gray-900 rounded-lg p-8 shadow-lg border border-gray-700" id="terminalSection" role="region">
<div class="flex justify-between items-center mb-6">
<h2 class="text-3xl font-semibold text-white">Process Payment</h2>
<button aria-label="Logout" class="bg-red-600 hover:bg-red-700 transition-colors duration-300 rounded-md py-2 px-4 font-semibold flex items-center space-x-2 text-white" id="logoutBtn">
<i class="fas fa-sign-out-alt"></i><span>Logout</span>
</button>
</div>
<form autocomplete="off" class="grid grid-cols-1 md:grid-cols-2 gap-6" id="paymentForm" novalidate="">
<div class="col-span-2 md:col-span-1">
<label class="block mb-1 font-semibold text-gray-300" for="cardNumber">Card Number</label>
<input aria-describedby="cardNumberHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 tracking-widest text-white" id="cardNumber" inputmode="numeric" maxlength="19" name="cardNumber" pattern="[\d ]{13,19}" placeholder="1234 5678 9012 3456" required="" type="text"/>
<p class="text-xs text-gray-500 mt-1" id="cardNumberHelp">Enter full card number (16 digits)</p>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-300" for="expiry">Expiry (MM/YY)</label>
<input aria-describedby="expiryHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-white" id="expiry" inputmode="numeric" maxlength="5" name="expiry" pattern="^(0[1-9]|1[0-2])\/?([0-9]{2})$" placeholder="MM/YY" required="" type="text"/>
<p class="text-xs text-gray-500 mt-1" id="expiryHelp">Format: MM/YY</p>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-300" for="cvc">CVC / CVV</label>
<input aria-describedby="cvcHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-white" id="cvc" inputmode="numeric" maxlength="4" name="cvc" pattern="^\d{3,4}$" placeholder="123" required="" type="text"/>
<p class="text-xs text-gray-500 mt-1" id="cvcHelp">3 or 4 digit security code</p>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-300" for="amount">Amount</label>
<input aria-describedby="amountHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-white" id="amount" inputmode="decimal" min="0.01" name="amount" placeholder="0.00" required="" step="0.01" type="number"/>
<p class="text-xs text-gray-500 mt-1" id="amountHelp">Enter amount to charge</p>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-300" for="currency">Currency</label>
<select aria-describedby="currencyHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" id="currency" name="currency" required="">
<option disabled="" selected="" value="">Select currency</option>
<option value="USD">USD - US Dollar</option>
<option value="EUR">EUR - Euro</option>
<option value="GBP">GBP - British Pound</option>
</select>
<p class="text-xs text-gray-500 mt-1" id="currencyHelp">Select transaction currency (No Crypto)</p>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-300" for="protocol">Protocol</label>
<select aria-describedby="protocolHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" id="protocol" name="protocol" required="">
<option disabled="" selected="" value="">Select protocol</option>
<option value="POS Terminal -101.1 (4-digit approval)">POS Terminal -101.1 (4-digit approval)</option>
<option value="POS Terminal -101.4 (6-digit approval)">POS Terminal -101.4 (6-digit approval)</option>
<option value="POS Terminal -101.6 (Pre-authorization)">POS Terminal -101.6 (Pre-authorization)</option>
<option value="POS Terminal -101.7 (4-digit approval)">POS Terminal -101.7 (4-digit approval)</option>
<option value="POS Terminal -101.8 (PIN-LESS transaction)">POS Terminal -101.8 (PIN-LESS transaction)</option>
<option value="POS Terminal -201.1 (6-digit approval)">POS Terminal -201.1 (6-digit approval)</option>
<option value="POS Terminal -201.3 (6-digit approval)">POS Terminal -201.3 (6-digit approval)</option>
<option value="POS Terminal -201.5 (6-digit approval)">POS Terminal -201.5 (6-digit approval)</option>
</select>
<p class="text-xs text-gray-500 mt-1" id="protocolHelp">Select the transaction protocol</p>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-300" for="authCode">Auth Code</label>
<input aria-describedby="authCodeHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-white" id="authCode" inputmode="numeric" maxlength="6" name="authCode" pattern="^\d{4}$|^\d{6}$" placeholder="Enter 4 or 6 digit auth code" required="" type="text"/>
<p class="text-xs text-gray-500 mt-1" id="authCodeHelp">4 or 6 digit numeric approval code</p>
</div>
<div class="col-span-2 md:col-span-1">
<label class="block mb-1 font-semibold text-gray-300">Payout Method</label>
<div class="flex space-x-4">
<label class="inline-flex items-center cursor-pointer">
<input checked="" class="form-radio text-green-500" name="payoutMethodRadio" type="radio" value="Bank Account"/>
<span class="ml-2 text-gray-300 select-none">Bank Account</span>
</label>
<label class="inline-flex items-center cursor-pointer">
<input class="form-radio text-green-500" name="payoutMethodRadio" type="radio" value="Crypto Wallet"/>
<span class="ml-2 text-gray-300 select-none">Crypto Wallet</span>
</label>
</div>
<p class="text-xs text-gray-500 mt-1">Select payout method</p>
</div>
<div class="col-span-2 md:col-span-1">
<label class="block mb-1 font-semibold text-gray-300" for="payoutDetails">Payout Details</label>
<textarea aria-describedby="payoutDetailsHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 text-gray-500 cursor-not-allowed resize-none" id="payoutDetails" name="payoutDetails" readonly="" rows="3">Loading payout credentials...</textarea>
<p class="text-xs text-gray-500 mt-1" id="payoutDetailsHelp">Merchant payout credentials (no manual entry)</p>
</div>
<div class="col-span-2 flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
<button aria-label="Process transaction" class="w-full md:w-auto bg-green-600 hover:bg-green-700 transition-colors duration-300 rounded-md py-4 font-semibold flex justify-center items-center space-x-3 text-white" id="processTransactionBtn" type="submit">
<i class="fas fa-credit-card"></i>
<span>Process Transaction</span>
</button>
<button aria-label="Print transaction history" class="w-full md:w-auto bg-gray-700 hover:bg-gray-600 transition-colors duration-300 rounded-md py-4 font-semibold flex justify-center items-center space-x-3 text-white" id="printHistoryBtn" type="button">
<i class="fas fa-print"></i>
<span>Print Transaction History</span>
</button>
</div>
</form>
<section aria-atomic="true" aria-live="polite" class="mt-8 max-h-64 overflow-y-auto bg-gray-900 rounded-lg p-4 space-y-3 font-mono text-sm text-green-400" id="notifications" role="log">
<h3 class="text-xl font-semibold mb-3 text-center text-blue-400">Real-Time MTI Notifications</h3>
<ul class="list-disc list-inside space-y-1" id="notificationList"></ul>
</section>
<section aria-label="Transaction History" class="mt-8 bg-gray-900 rounded-lg p-6 max-h-96 overflow-y-auto font-mono text-sm text-gray-300" id="transactionHistorySection">
<h3 class="text-xl font-semibold mb-4 text-center text-blue-400">Transaction History</h3>
<table class="w-full table-auto border-collapse border border-gray-700">
<thead>
<tr class="bg-gray-800">
<th class="border border-gray-700 px-3 py-2 text-left">Date &amp; Time</th>
<th class="border border-gray-700 px-3 py-2 text-left">Card Ending</th>
<th class="border border-gray-700 px-3 py-2 text-left">Amount</th>
<th class="border border-gray-700 px-3 py-2 text-left">Currency</th>
<th class="border border-gray-700 px-3 py-2 text-left">Protocol</th>
<th class="border border-gray-700 px-3 py-2 text-left">Auth Code</th>
<th class="border border-gray-700 px-3 py-2 text-left">Status</th>
</tr>
</thead>
<tbody id="transactionHistoryBody">
<tr><td class="text-center py-4 text-gray-500" colspan="7">No transactions yet.</td></tr>
</tbody>
</table>
</section>
</section>
</div>
<!-- Forgot Password Modal -->
<div aria-describedby="forgotPasswordDesc" aria-labelledby="forgotPasswordTitle" aria-modal="true" class="fixed inset-0 flex items-center justify-center z-50 hidden" id="forgotPasswordModal" role="dialog">
<div class="modal-backdrop absolute inset-0"></div>
<div class="relative bg-gray-900 rounded-lg shadow-lg max-w-md w-full p-6 border border-gray-700">
<h3 class="text-xl font-semibold mb-4 text-white" id="forgotPasswordTitle">Forgot Password</h3>
<p class="mb-4 text-gray-400" id="forgotPasswordDesc">To reset your password, please authenticate using your Authenticator app (Google Authenticator, Authy, etc.).</p>
<form class="space-y-4" id="forgotPasswordForm" novalidate="">
<div>
<label class="block mb-1 font-semibold text-gray-300" for="authCodeFP">Authenticator Code</label>
<input aria-describedby="authCodeFPHelp" class="w-full rounded-md px-4 py-3 bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white text-center" id="authCodeFP" inputmode="numeric" maxlength="6" name="authCodeFP" pattern="^\d{6}$" placeholder="Enter 6-digit code" required="" type="text"/>
<p class="text-xs text-gray-500 mt-1" id="authCodeFPHelp">Enter the 6-digit code from your Authenticator app</p>
</div>
<div class="flex justify-end space-x-4">
<button class="bg-gray-700 hover:bg-gray-600 transition-colors duration-300 rounded-md py-2 px-4 font-semibold text-white" id="cancelForgotPassword" type="button">Cancel</button>
<button class="bg-blue-600 hover:bg-blue-700 transition-colors duration-300 rounded-md py-2 px-4 font-semibold text-white" type="submit">Verify</button>
</div>
</form>
<p aria-live="assertive" class="mt-3 text-red-500 text-center hidden" id="forgotPasswordError" role="alert"></p>
</div>
</div>
<!-- Processing Modal -->
<div aria-label="Processing transaction" aria-live="assertive" aria-modal="true" class="fixed inset-0 flex items-center justify-center z-50 hidden" id="processingModal" role="alert">
<div class="modal-backdrop absolute inset-0"></div>
<div class="relative bg-gray-900 rounded-lg shadow-lg max-w-sm w-full p-6 border border-gray-700 flex flex-col items-center space-y-4">
<svg aria-hidden="true" class="animate-spin h-12 w-12 text-blue-500" fill="none" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
<path class="opacity-75" d="M4 12a8 8 0 018-8v8H4z" fill="currentColor"></path>
</svg>
<p class="text-white text-lg font-semibold">Processing<span id="processingDots">.</span></p>
</div>
</div>
<!-- Result Popup -->
<div aria-label="Transaction result" aria-live="assertive" aria-modal="true" class="fixed inset-0 flex items-center justify-center z-50 hidden" id="resultPopup" role="alert">
<div class="modal-backdrop absolute inset-0"></div>
<div class="relative bg-gray-900 rounded-lg shadow-lg max-w-sm w-full p-6 border border-gray-700 flex flex-col items-center space-y-4">
<div class="text-green-500 text-6xl" id="resultIcon"><i class="fas fa-check-circle"></i></div>
<p class="text-white text-lg font-semibold text-center" id="resultMessage"></p>
<button class="bg-blue-600 hover:bg-blue-700 transition-colors duration-300 rounded-md py-2 px-6 font-semibold text-white focus:outline-none" id="closeResultPopup">Close</button>
</div>
</div>
<script>
    // === Auto-detect API Base ===
    const dockerMode = window.location.hostname === "frontend" || window.location.hostname.endsWith(".docker.internal");
    const API_BASE = dockerMode ? "http://project-backend:8000" : "http://localhost:8002";
    const API_TRANSACTIONS_URL = `${API_BASE}/transactions`;
    const API_PAYOUT_URL = `${API_BASE}/payout`;
    const API_WS_URL = `${API_BASE.replace(/^http/, 'ws')}/ws`;

    console.log("ðŸ”— Using API_BASE =", API_BASE);

    // Elements
    const loginSection = document.getElementById("loginSection");
    const terminalSection = document.getElementById("terminalSection");
    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");
    const paymentForm = document.getElementById("paymentForm");
    const payoutDetailsInput = document.getElementById("payoutDetails");
    const notificationList = document.getElementById("notificationList");
    const authCodeInput = document.getElementById("authCode");
    const protocolSelect = document.getElementById("protocol");
    const amountInput = document.getElementById("amount");
    const currencySelect = document.getElementById("currency");
    const transactionHistoryBody = document.getElementById("transactionHistoryBody");
    const printHistoryBtn = document.getElementById("printHistoryBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const terminalStatus = document.getElementById("terminalStatus");
    const statusIndicator = document.getElementById("statusIndicator");
    const statusText = document.getElementById("statusText");
// === Transaction history persistence (localStorage) ===
// NOTE: uses key 'tx_history_v1'. Keeps date as ISO string.
window.transactionHistory = window.transactionHistory || [];
var transactionHistory = window.transactionHistory = window.transactionHistory || [];

// Save transactionHistory to localStorage (convert Date -> ISO)
function saveTransactionHistory(){
  try{
    const serial = transactionHistory.map(t => {
      const copy = Object.assign({}, t);
      if (copy.date && copy.date.toISOString) copy.date = copy.date.toISOString();
      else if (copy.date && typeof copy.date === 'object') copy.date = new Date(copy.date).toISOString();
      else if (!copy.date) copy.date = (new Date()).toISOString();
      return copy;
    });
    localStorage.setItem('tx_history_v1', JSON.stringify(serial));
  }catch(e){ console.warn('saveTransactionHistory err', e); }
}

// Load transactionHistory from localStorage and render rows
function loadTransactionHistory(){
  try{
    const raw = localStorage.getItem('tx_history_v1');
    if (!raw) return;
    const arr = JSON.parse(raw);
    // convert date strings back to Date objects when useful
    arr.forEach(a => {
      if (a.date && typeof a.date === 'string') a.date = new Date(a.date);
      appendTransaction(a);
    });
  }catch(e){ console.warn('loadTransactionHistory err', e); }
}

// Centralized renderer for a single transaction row (used on create & restore)
function _renderTransactionRow(tx){
  if (!transactionHistoryBody) return;
  // ensure the table exists
  if (transactionHistory.length === 0) { transactionHistoryBody.innerHTML = ""; }

  // set job id on row for WS updates
  const tr = document.createElement("tr");
  tr.className = "border border-gray-700";
  if (tx.job_id) tr.dataset.jobId = tx.job_id;

  const statusClass = (tx.status && tx.status.toLowerCase && tx.status.toLowerCase() === 'approved') ? 'text-green-400 font-semibold' : 'text-red-500 font-semibold';
  const txLinkHTML = tx.txhash ? `<div class="mt-1"><a href="https://etherscan.io/tx/${tx.txhash}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-300 hover:underline">View tx</a></div>` : "";
  const dateStr = (tx.date && tx.date.toLocaleString) ? tx.date.toLocaleString() : (new Date()).toLocaleString();
  const amountStr = (typeof tx.amount !== 'undefined') ? tx.amount : '';

  tr.innerHTML = `
    <td class="border border-gray-700 px-3 py-1">${dateStr}</td>
    <td class="border border-gray-700 px-3 py-1">${tx.cardEnding || ''}</td>
    <td class="border border-gray-700 px-3 py-1">${amountStr}</td>
    <td class="border border-gray-700 px-3 py-1">${tx.currency || ''}</td>
    <td class="border border-gray-700 px-3 py-1">${tx.protocol || ''}</td>
    <td class="border border-gray-700 px-3 py-1">${tx.authCode || ''}</td>
    <td class="border border-gray-700 px-3 py-1 ${statusClass}">
      ${tx.status || ''}
      ${txLinkHTML}
    </td>
  `;
  // newest on top
  transactionHistoryBody.prepend(tr);
}

// Public helper to append a tx (call this whenever you add a tx)
function appendTransaction(tx){
  try{
    // normalize date
    if (tx.date && typeof tx.date === 'string') tx.date = new Date(tx.date);
    if (!tx.date) tx.date = new Date();

    // ensure transactionHistory array exists
    if (!Array.isArray(transactionHistory)) transactionHistory = [];

    // push into memory
    transactionHistory.push(tx);

    // render one row for this tx
    try{ _renderTransactionRow(tx); } catch(e){ console.warn('_renderTransactionRow error', e); }

    // persist to localStorage (dates -> ISO)
    try{
      const serial = transactionHistory.map(t => {
        const c = Object.assign({}, t);
        if (c.date && c.date.toISOString) c.date = c.date.toISOString();
        else if (c.date && typeof c.date === 'object') c.date = new Date(c.date).toISOString();
        else if (!c.date) c.date = (new Date()).toISOString();
        return c;
      });
      localStorage.setItem('tx_history_v1', JSON.stringify(serial));
    }catch(e){ console.warn('saveTransactionHistory err', e); }
  }catch(e){
    console.warn('appendTransaction err', e);
  }
}

// Ensure loadTransactionHistory uses appendTransaction only
function loadTransactionHistory(){
  try{
    const raw = localStorage.getItem('tx_history_v1');
    if (!raw) return;
    const arr = JSON.parse(raw);
    // clear existing rendered rows first (if your UI expects fresh render)
    if (typeof transactionHistoryBody !== 'undefined' && transactionHistoryBody) transactionHistoryBody.innerHTML = '';
    transactionHistory = [];
    arr.forEach(a => {
      if (a.date && typeof a.date === 'string') a.date = new Date(a.date);
      appendTransaction(a);
    });
  }catch(e){ console.warn('loadTransactionHistory err', e); }
}
window.txPersistence = { save: saveTransactionHistory, load: loadTransactionHistory, append: appendTransaction };

// Load saved history on script load
loadTransactionHistory();

// Optional: auto-save on unload (extra safety)
window.addEventListener('beforeunload', saveTransactionHistory);


    const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");
    const forgotPasswordModal = document.getElementById("forgotPasswordModal");
    const forgotPasswordForm = document.getElementById("forgotPasswordForm");
    const cancelForgotPassword = document.getElementById("cancelForgotPassword");
    const forgotPasswordError = document.getElementById("forgotPasswordError");

    const processingModal = document.getElementById("processingModal");
    const processingDots = document.getElementById("processingDots");

    const resultPopup = document.getElementById("resultPopup");
    const resultIcon = document.getElementById("resultIcon");
    const resultMessage = document.getElementById("resultMessage");
    const closeResultPopup = document.getElementById("closeResultPopup");

    const payoutMethodRadios = document.querySelectorAll('input[name="payoutMethodRadio"]');

    const TEST_USER = "admin";
    const TEST_PASS = "Br_3339";

    transactionHistory = transactionHistory || [];

    // Online status now tied to API reachability (instead of timer)
    async function pingApi() {
      try {
        const r = await fetch(`${API_BASE}/health`, { method: 'GET' });
        online = r.ok;
      } catch { online = false; }
      updateTerminalStatus();
    }
    let online = false;
    setInterval(pingApi, 10000); // poll every 10s
    pingApi();

    function updateTerminalStatus() {
      if (online) {
        statusIndicator.classList.remove("bg-red-600", "animate-pulse");
        statusIndicator.classList.add("bg-green-500");
        statusText.textContent = "Online";
        statusText.classList.remove("text-gray-400");
        statusText.classList.add("text-green-500");
        enableProcessButton();
      } else {
        statusIndicator.classList.remove("bg-green-500");
        statusIndicator.classList.add("bg-red-600", "animate-pulse");
        statusText.textContent = "Offline";
        statusText.classList.remove("text-green-500");
        statusText.classList.add("text-gray-400");
        disableProcessButton();
      }
    }

    function enableProcessButton(){ const btn = paymentForm.querySelector("button[type=submit]"); if(btn){ btn.disabled=false; btn.classList.remove("opacity-50","cursor-not-allowed"); } }
    function disableProcessButton(){ const btn = paymentForm.querySelector("button[type=submit]"); if(btn){ btn.disabled=true; btn.classList.add("opacity-50","cursor-not-allowed"); } }

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      loginError.classList.add("hidden");
      const username = loginForm.merchantEmail.value.trim();
      const password = loginForm.merchantPassword.value.trim();
      if (!username || !password) { loginError.textContent = "Username and password are required."; loginError.classList.remove("hidden"); return; }
      if (username !== TEST_USER || password !== TEST_PASS) { loginError.textContent = "Invalid username or password."; loginError.classList.remove("hidden"); return; }
      const loginBtn = loginForm.querySelector("button[type=submit]");
      loginBtn.disabled = true; loginBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Logging in...`;
      setTimeout(() => {
        loginSection.classList.add("hidden");
        terminalSection.classList.remove("hidden");
        loginBtn.disabled = false; loginBtn.innerHTML = `<i class=\"fas fa-sign-in-alt\"></i> Login`;
        loadPayoutCredentials();
        if (online) enableProcessButton(); else disableProcessButton();
        try { connectWs(); } catch {}
      }, 800);
    });

    function loadPayoutCredentials(){ updatePayoutDetails(); }
    function updatePayoutDetails(){
      const selected = Array.from(payoutMethodRadios).find(r => r.checked);
      if (!selected) return;
      if (selected.value === "Bank Account") {
        payoutDetailsInput.value = "Bank: First National Bank\nAccount Number: 123456789\nRouting Number: 987654321";
      } else {
        payoutDetailsInput.value = "Wallet Address: 0xAbC1234Ef567890dEfABc1234567890aBCdef123";
      }
    }
    payoutMethodRadios.forEach(r => r.addEventListener("change", updatePayoutDetails));

    const cardNumberInput = document.getElementById("cardNumber");
    cardNumberInput.addEventListener("input", (e) => {
      let value = e.target.value.replace(/\D/g, "").substring(0, 16);
      let formatted = "";
      for (let i=0; i<value.length; i+=4){ if(i>0) formatted += " "; formatted += value.substring(i, i+4); }
      e.target.value = formatted;
    });

    const expiryInput = document.getElementById("expiry");
    expiryInput.addEventListener("input", (e) => {
      let val = e.target.value.replace(/[^\d]/g, "").substring(0,4);
      if (val.length >= 3) { val = val.substring(0,2) + "/" + val.substring(2); }
      e.target.value = val;
    });

    protocolSelect.addEventListener("change", () => {
      const protocol = protocolSelect.value;
      const length = ({
        "POS Terminal -101.1 (4-digit approval)": 4,
        "POS Terminal -101.4 (6-digit approval)": 6,
        "POS Terminal -101.6 (Pre-authorization)": 6,
        "POS Terminal -101.7 (4-digit approval)": 4,
        "POS Terminal -101.8 (PIN-LESS transaction)": 4,
        "POS Terminal -201.1 (6-digit approval)": 6,
        "POS Terminal -201.3 (6-digit approval)": 6,
        "POS Terminal -201.5 (6-digit approval)": 6
      })[protocol] || 6;
      authCodeInput.maxLength = length;
      authCodeInput.placeholder = `Enter ${length}-digit auth code`;
      authCodeInput.value = "";
    });

    // --------- API bridge helpers -----------
    async function sendTransactionToApi(payload){
      const res = await fetch(API_TRANSACTIONS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok){
        const err = await res.json().catch(() => ({detail: res.statusText}));
        const msg = (typeof err.detail === 'string') ? err.detail : (err.detail ? JSON.stringify(err.detail) : undefined);
        throw new Error(msg || "Bridge error");}
      return res.json();
    }

    async function createPayout(payload){
      // the backend should return: { approved: true|false, de39: "...", de38: "...", job_id: "uuid", txhash: null|"..."}
      const res = await fetch(API_PAYOUT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok){
        const err = await res.json().catch(()=>({detail:res.statusText}));
        const msg = (typeof err.detail === 'string') ? err.detail : (err.detail ? JSON.stringify(err.detail) : undefined);
        throw new Error(msg || "Payout API error");}

      return res.json();
    }

    // --------- Form submit handler (patched to include job_id & txhash) -----------
    paymentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!online){ alert("API offline. Please wait until it is online."); return; }

      const cardNumberRaw = cardNumberInput.value.replace(/\s/g, "");
      const expiry = expiryInput.value;
      const cvc = paymentForm.cvc.value.trim();
      const protocol = protocolSelect.value;
      const authCode = authCodeInput.value.trim();
      const amount = parseFloat(amountInput.value);
      const currency = currencySelect.value;
      const payoutMethod = Array.from(payoutMethodRadios).find(r => r.checked)?.value || "";

      if (!/^\d{16}$/.test(cardNumberRaw)) { alert("Card number must be 16 digits."); cardNumberInput.focus(); return; }
      if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)) { alert("Expiry must be in MM/YY format."); expiryInput.focus(); return; }
      const [month, year] = expiry.split("/");
      const expDate = new Date(2000 + parseInt(year, 10), parseInt(month, 10) - 1, 1);
      const now = new Date(); now.setDate(1); now.setHours(0,0,0,0);
      if (expDate < now) { alert("Card expiry date is in the past."); expiryInput.focus(); return; }
      if (!/^\d{3,4}$/.test(cvc)) { alert("CVC must be 3 or 4 digits."); paymentForm.cvc.focus(); return; }
      if (isNaN(amount) || amount <= 0) { alert("Please enter a valid amount greater than zero."); amountInput.focus(); return; }
      if (!currency) { alert("Please select a currency."); currencySelect.focus(); return; }
      if (!protocol) { alert("Please select a valid protocol."); protocolSelect.focus(); return; }
      const requiredAuthLength = authCodeInput.maxLength || 6;
      if (!new RegExp(`^\\d{${requiredAuthLength}}$`).test(authCode)) { alert(`Auth code must be exactly ${requiredAuthLength} digits.`); authCodeInput.focus(); return; }

      const submitBtn = paymentForm.querySelector("button[type=submit]");
      submitBtn.disabled = true; submitBtn.innerHTML = `<i class='fas fa-spinner fa-spin'></i> Processing...`;
      showProcessingModal();

      try {
        // Prefer client_id (the WS id) so backend's notify_client(job["merchant_id"]) reaches the same WS connection
        const vtPayload = { merchant_id: (localStorage.getItem("client_id") || localStorage.getItem("merchant_id") || "merchant_default"), cardNumber: cardNumberRaw, expiry, cvc, amount: amount.toFixed(2), currency, protocol, authCode, payoutMethod, payoutDetails: payoutDetailsInput.value };
        // Primary call: create payout/job on backend
        const apiResult = await createPayout(vtPayload);

        // create tx object for UI. backend may return job_id and/or txhash if broadcasted immediately
        const txObj = {
          date: new Date(),
          cardEnding: cardNumberRaw.slice(-4),
          amount: amount.toFixed(2),
          currency,
          protocol,
          authCode,
          status: apiResult.approved ? "Approved" : "Rejected",
          payoutMethod,
          job_id: apiResult.job_id || null,
          txhash: apiResult.txhash || null
        };

        appendTransaction(txObj);
        if (apiResult.approved) {
          const msg = `Approved (DE39=${apiResult.de39}${apiResult.de38 ? ", Auth="+apiResult.de38 : ""})`;
          showResultPopup(true, msg, txObj.txhash);
        } else {
          showResultPopup(false, `Rejected (DE39=${apiResult.de39})`, txObj.txhash);
        }

        paymentForm.reset();
        authCodeInput.maxLength = 6; authCodeInput.placeholder = "Enter 4 or 6 digit auth code"; updatePayoutDetails();
      } catch (error) {
        showResultPopup(false, "Transaction Error: " + (error.message || error));
      } finally {
        submitBtn.disabled = false; submitBtn.innerHTML = `<i class='fas fa-credit-card'></i> Process Transaction`;
        hideProcessingModal();
      }
    });

    // --------- appendTransaction(patched) -----------
    function appendTransaction(tx){
      // tx expected shape:
      // { date: Date, cardEnding: "1234", amount: "1.00", currency:"USD",
      //   protocol:"...", authCode:"...", status:"Approved"|"Rejected", payoutMethod:"...", txhash: "0x...", job_id: "uuid" }

      if (transactionHistory.length === 0) { transactionHistoryBody.innerHTML = ""; }
      transactionHistory.push(tx);
      const tr = document.createElement("tr");
      tr.className = "border border-gray-700";

      // set job id on row for WS updates
      if (tx.job_id) tr.dataset.jobId = tx.job_id;

      // status styling
      const statusClass = (tx.status && tx.status.toLowerCase() === 'approved') ? 'text-green-400 font-semibold' : 'text-red-500 font-semibold';

      // optional tx link HTML
      const txLinkHTML = tx.txhash ? `<div class="mt-1"><a href="https://etherscan.io/tx/${tx.txhash}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-300 hover:underline">View tx</a></div>` : "";

      // safe formatting for date & amount
      const dateStr = (tx.date && tx.date.toLocaleString) ? tx.date.toLocaleString() : (new Date()).toLocaleString();
      const amountStr = (typeof tx.amount !== 'undefined') ? tx.amount : '';

      tr.innerHTML = `
        <td class="border border-gray-700 px-3 py-1">${dateStr}</td>
        <td class="border border-gray-700 px-3 py-1">${tx.cardEnding || ''}</td>
        <td class="border border-gray-700 px-3 py-1">${amountStr}</td>
        <td class="border border-gray-700 px-3 py-1">${tx.currency || ''}</td>
        <td class="border border-gray-700 px-3 py-1">${tx.protocol || ''}</td>
        <td class="border border-gray-700 px-3 py-1">${tx.authCode || ''}</td>
        <td class="border border-gray-700 px-3 py-1 ${statusClass}">
          ${tx.status || ''}
          ${txLinkHTML}
        </td>
      `;
      transactionHistoryBody.prepend(tr);
    }

    printHistoryBtn.addEventListener("click", () => {
      const printContent = document.createElement("div");
      printContent.id = "printableArea"; printContent.style.background = "#fff"; printContent.style.color = "#000"; printContent.style.padding = "1rem"; printContent.style.fontFamily = "'Roboto Mono', monospace";
      printContent.innerHTML = `
        <h2 style="text-align:center; margin-bottom:1rem;">Transaction History</h2>
        <table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse: collapse; font-size: 12px;">
          <thead><tr><th>Date & Time</th><th>Card Ending</th><th>Amount</th><th>Currency</th><th>Protocol</th><th>Auth Code</th><th>Status</th></tr></thead>
          <tbody>
          ${transactionHistory.map(tx => `
            <tr><td>${tx.date.toLocaleString()}</td><td>${tx.cardEnding}</td><td>${tx.amount}</td><td>${tx.currency}</td><td>${tx.protocol}</td><td>${tx.authCode}</td><td>${tx.status}</td></tr>
          `).join('')}
          </tbody>
        </table>`;
      document.body.appendChild(printContent); window.print(); document.body.removeChild(printContent);
    });

    // Forgot Password Modal Logic
    forgotPasswordBtn.addEventListener("click", () => { forgotPasswordError.classList.add("hidden"); forgotPasswordForm.authCodeFP.value = ""; forgotPasswordModal.classList.remove("hidden"); forgotPasswordForm.authCodeFP.focus(); });
    cancelForgotPassword.addEventListener("click", () => { forgotPasswordModal.classList.add("hidden"); });
    forgotPasswordForm.addEventListener("submit", (e) => { e.preventDefault(); forgotPasswordError.classList.add("hidden"); const code = forgotPasswordForm.authCodeFP.value.trim(); if (!/^\d{6}$/.test(code)) { forgotPasswordError.textContent = "Invalid code. Please enter a 6-digit authenticator code."; forgotPasswordError.classList.remove("hidden"); return; } alert("Authenticator verified. Password reset instructions sent to your registered email."); forgotPasswordModal.classList.add("hidden"); });

    // Processing Modal Logic
    let processingInterval; function showProcessingModal(){ processingModal.classList.remove("hidden"); let dots=1; processingInterval=setInterval(()=>{ dots=(dots%3)+1; processingDots.textContent = ".".repeat(dots); },500); }
    function hideProcessingModal(){ processingModal.classList.add("hidden"); clearInterval(processingInterval); processingDots.textContent = "."; }

    // --------- Result Popup (patched to show tx link when available) -----------
    function showResultPopup(success, message, txhash){
      // set icon
      const iconHtml = success
        ? '<i class="fas fa-check-circle text-green-400" aria-hidden="true"></i>'
        : '<i class="fas fa-times-circle text-red-400" aria-hidden="true"></i>';
      if (typeof resultIcon !== "undefined" && resultIcon !== null) {
        resultIcon.innerHTML = iconHtml;
      }

      // set message text
      if (typeof resultMessage !== "undefined" && resultMessage !== null) {
        resultMessage.textContent = message;
      }

      // remove previous tx link if present
      const prev = document.getElementById("resultTxLink");
      if (prev) prev.remove();

      // append Etherscan link if txhash provided
      if (txhash && typeof txhash === "string" && txhash.startsWith("0x")) {
        const link = document.createElement("a");
        link.id = "resultTxLink";
        link.href = `https://etherscan.io/tx/${txhash}`;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.className = "mt-2 text-sm text-blue-300 hover:underline";
        link.textContent = `View on Etherscan (${txhash.slice(0,10)}...)`;
        if (typeof resultMessage !== "undefined" && resultMessage !== null && resultMessage.parentNode) {
          resultMessage.insertAdjacentElement("afterend", link);
        } else if (typeof resultPopup !== "undefined" && resultPopup !== null) {
          resultPopup.appendChild(link);
        }
      }

      // show popup
      if (typeof resultPopup !== "undefined" && resultPopup !== null) {
        resultPopup.classList.remove("hidden");
      }
    }
    closeResultPopup.addEventListener("click", () => { resultPopup.classList.add("hidden"); });

    // --------- WebSocket + client id for async updates -----------
    let ws;
    let CLIENT_ID = localStorage.getItem("client_id");
    if (!CLIENT_ID) {
      CLIENT_ID = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2));
      localStorage.setItem("client_id", CLIENT_ID);
    }

    function connectWs(){
      try {
        const wsUrl = `${API_BASE.replace(/^http/, 'ws')}/ws/${CLIENT_ID}`;
        ws = new WebSocket(wsUrl);
        ws.onopen = () => console.log("WS connected:", wsUrl);
        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            // support both { type: 'payout.result', ... } and legacy topic/data shape
            if (msg.type === "payout.result") {
              handlePayoutResult(msg);
              return;
            }
            const topic = msg.topic || msg.type;
            const data = msg.data || msg.payload || {};
            if (["mti.incoming","mti.outgoing","payout.request","payout.result"].includes(topic)) {
              const li=document.createElement("li");
              li.className = topic.includes("outgoing") ? "text-blue-400" : "text-green-400";
              li.textContent = `${topic} â†’ MTI=${data.mti || "-"} ${data.fields ? JSON.stringify(data.fields) : ""}`;
              notificationList.appendChild(li);
              notificationList.scrollTop = notificationList.scrollHeight;
            }
          } catch(e){
            console.error("WS message parse error", e);
          }
        };
        ws.onclose = () => { console.log("WS closed, reconnect in 3s"); setTimeout(connectWs, 3000); };
        ws.onerror = (e) => { console.warn("WS error", e); };
      } catch(e){
        console.error("WS connect error", e);
      }
    }

    // Handle payout.result messages and update transaction row
    function handlePayoutResult(msg){
      // expected msg: { type: "payout.result", job_id: "...", txhash: "...", status: "success" }
      const jobId = msg.job_id || msg.jobId || (msg.data && msg.data.job_id);
      const txhash = msg.txhash || (msg.data && msg.data.txhash);
      const status = msg.status || (msg.data && msg.data.status) || 'Approved';

      if (!jobId) {
        console.warn("payout.result without job_id", msg);
        return;
      }

      // find row with matching data-job-id
      const row = document.querySelector(`tr[data-job-id='${jobId}']`);
      if (row) {
        const statusCell = row.children[row.children.length - 1];
        // update status text and add link
        statusCell.className = "border border-gray-700 px-3 py-1 text-green-400 font-semibold";
        statusCell.innerHTML = `${status === "success" ? "Approved" : status}<div class="mt-1"><a href="https://etherscan.io/tx/${txhash}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-300 hover:underline">View tx</a></div>`;
      } else {
        // optionally add a new row if not found
        console.warn("Row for job_id not found:", jobId);
      }
    }

    // Connect WS on page load if in terminal view
    // connectWs() is called after login, see login handler

    // Utility: expose simple health fetch for testing
    async function getPayoutStatus(jobId){
      try {
        const r = await fetch(`${API_BASE}/payout/${jobId}`);
        return r.json();
      } catch(e){ return null; }
    }
  </script>
</body>
</html>

